<!DOCTYPE html>
<html lang="en-us">
<head>

<meta charset="utf-8">
<meta name="viewport" content="width=device-width, initial-scale=1.0">
<meta http-equiv="content-type" content="text/html; charset=utf-8">
<meta http-equiv="X-UA-Compatible" content="IE=edge">

<meta name="description" content="Personal website and blog of yet another software developer">
<meta name="keywords" content="utsav,gupta,utsavgupta,utsavgupta89,go lang,go,scala,microservices,sveltejs,go-unison">

<base href="/">

<title>
  Utsav Gupta - Unison: A Datastore migration library for Google Go 
</title>

<meta name="generator" content="Hugo 0.55.6" />


<link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/highlight.js/9.12.0/styles/default.min.css">


<link rel="stylesheet" href="https://fonts.googleapis.com/css?family=Lato:300,400|Roboto+Slab:400,700|Roboto:300,300i,400,400i,500,500i,700,700i">
<link rel="stylesheet" href="https://maxcdn.bootstrapcdn.com/bootstrap/3.3.7/css/bootstrap.min.css" integrity="sha384-BVYiiSIFeK1dGmJRAkycuHAHRg32OmUcww7on3RYdg4Va+PmSTsz/K68vbdEjh4u" crossorigin="anonymous">
<link rel="stylesheet" href="https://use.fontawesome.com/releases/v5.8.2/css/all.css" integrity="sha384-oS3vJWv+0UjzBfQzYUhtDYW+Pj2yciDJxpsK1OYPAYjqT085Qq/1cq5FLXAZQ7Ay" crossorigin="anonymous">
<link rel="stylesheet" href="/css/main.css">
<link rel="stylesheet" href="/css/custom.css">




<link rel="apple-touch-icon" sizes="180x180" href="/apple-touch-icon.png">
<link rel="icon" type="image/png" href="/favicon-32x32.png" sizes="32x32">
<link rel="icon" type="image/png" href="/favicon-16x16.png" sizes="16x16">
<link rel="manifest" href="/manifest.json">
<link rel="mask-icon" href="/safari-pinned-tab.svg" color="#5bbad5">
<meta name="theme-color" content="#ffffff">

</head>
<body lang="en-us">
<div class="container">


<header class="row text-left title">
  <h1 class="title">Unison: A Datastore migration library for Google Go</h1>
</header>
<section id="category-pane" class="row meta">
  
  <div class="col-md-12">
    <h6 class="text-left meta">
        PUBLISHED ON MAR 17, 2020 
      
    </h6>
  </div>
  
</section>
<section id="content-pane" class="row">
  <div class="col-md-12 text-justify content">
    
    
    
    <p>Unison is a lightweight library that allows you to version and manage your Datastore migrations. In this blog article we will have a look at how you can install the Unison command line tool and get started migrating entities to Datastore.</p>

<p><em>Note: At the time of writing this article the library was not compatible with Google Firestore.</em></p>

<p><em>Before we begin, the article assumes that you have Google Go installed on your computer. In case you do not have it installed, <a href="https://golang.org/dl/">click here</a> to grab an installer for your operating system.</em></p>

<p>The go-unison project comprises two packages, viz, unison and unisoner. The first is the library that you will use to migrate your scripts, while the latter is a command line tool that lets you generate new migration scripts.</p>

<p>Let&rsquo;s start with creating a migration script that migrates some delicious fruits to Datastore. Run the following commands to set up your project.</p>
<div class="highlight"><pre class="chroma"><code class="language-bash" data-lang="bash">$ mkdir goapp
$ <span class="nb">cd</span> goapp
goapp $ go mod init goapp
goapp $ go get cloud.google.com/go/datastore
goapp $ mkdir ent
goapp $ touch ent/fruit.go
goapp $ touch main.go</code></pre></div>
<p>The <code>ent/fruit.go</code> file should contain the serializable Datastore entity structure as follows.</p>
<div class="highlight"><pre class="chroma"><code class="language-go" data-lang="go"><span class="kn">package</span> <span class="nx">ent</span>

<span class="kd">type</span> <span class="nx">Fruit</span> <span class="kd">struct</span> <span class="p">{</span>
    <span class="nx">ID</span>   <span class="kt">string</span> <span class="s">`datastore:&#34;id&#34;`</span>
    <span class="nx">Name</span> <span class="kt">string</span> <span class="s">`datastore:&#34;Name&#34;`</span>
<span class="p">}</span></code></pre></div>
<p>Now let&rsquo;s go ahead and install the unisoner command line tool and the unison library.</p>
<div class="highlight"><pre class="chroma"><code class="language-bash" data-lang="bash">goapp $ go get github.com/utsavgupta/go-unison/unisoner
goapp $ go get github.com/utsavgupta/go-unison/unison</code></pre></div>
<p>We are now ready to create new migration files. When your execute the unisoner command it creates the following to bootstrap unison.</p>

<ul>
<li><em>Migration package</em>: A new package is created in the present working directory. By default the name of this package is migration. But this can be overridden by either setting the environment variable <code>unison_migration_package</code> or by passing <code>--migration_package &lt;pkg_name&gt;</code> while executing the command. Note: if values are received from both, environment variable and the command line param, the latter will be given precedence.</li>
<li><em>Unison migrations type</em>: A new type gets created within the above package. It is on this type new migrations will be defined. Finally an instance of this type needs to be passed to the unison library for it to work its magic.</li>
</ul>

<p>Now with the details out of the way let&rsquo;s create our first migration script.</p>
<div class="highlight"><pre class="chroma"><code class="language-bash" data-lang="bash">goapp $ unisoner --migration_package gcp
Filename <span class="o">[</span>.go extension is automatically appended<span class="o">]</span> <span class="o">(</span>default -&gt; Apply1584396052<span class="o">)</span>: fruits
Description: add fruits</code></pre></div>
<p>Let&rsquo;s examine the files that were generated by unison.</p>
<div class="highlight"><pre class="chroma"><code class="language-bash" data-lang="bash">goapp $ ls gcp/
fruits.go   unison.go</code></pre></div>
<p>The file unison.go contains the migrations type that has been explained above. The other file is where the migration script goes.</p>

<p>Open <code>gcp/fruits.go</code> in a text editor and the contents should look like the following.</p>
<div class="highlight"><pre class="chroma"><code class="language-go" data-lang="go"><span class="kn">package</span> <span class="nx">gcp</span>

<span class="kn">import</span> <span class="p">(</span>
    <span class="s">&#34;cloud.google.com/go/datastore&#34;</span>
<span class="p">)</span>

<span class="c1">// Apply1584396052 add fruits
</span><span class="c1"></span><span class="kd">func</span> <span class="p">(</span><span class="nx">u</span> <span class="o">*</span><span class="nx">UnisonMigrations</span><span class="p">)</span> <span class="nf">Apply1584396052</span><span class="p">(</span><span class="nx">t</span> <span class="o">*</span><span class="nx">datastore</span><span class="p">.</span><span class="nx">Transaction</span><span class="p">,</span> <span class="nx">ns</span> <span class="kt">string</span><span class="p">)</span> <span class="kt">error</span> <span class="p">{</span>

    <span class="k">return</span> <span class="kc">nil</span>
<span class="p">}</span></code></pre></div>
<p>Each migration file we generate should ideally contain one method defined on UnisonMigrations. These method names are based on the following naming convention <code>Apply&lt;Timestamp&gt;</code>. It is based on this timestamp that the unison library sorts the order of migrations. A migration once successfully commited <em>will not</em> be run again. Only migrations that have a timestamp greater than the last successully executed migration will be executed.</p>

<p>Since I love eating apples and mangoes, I will migrate these two fruits to Datastore. Let&rsquo;s make the following changes to <code>gcp/fruits.go</code> (you can use your favorites here ðŸ˜‰).</p>
<div class="highlight"><pre class="chroma"><code class="language-go" data-lang="go"><span class="kn">package</span> <span class="nx">gcp</span>

<span class="kn">import</span> <span class="p">(</span>
    <span class="s">&#34;goapp/ent&#34;</span>

    <span class="s">&#34;cloud.google.com/go/datastore&#34;</span>
<span class="p">)</span>

<span class="c1">// Apply1584396052 add fruits
</span><span class="c1"></span><span class="kd">func</span> <span class="p">(</span><span class="nx">u</span> <span class="o">*</span><span class="nx">UnisonMigrations</span><span class="p">)</span> <span class="nf">Apply1584396052</span><span class="p">(</span><span class="nx">t</span> <span class="o">*</span><span class="nx">datastore</span><span class="p">.</span><span class="nx">Transaction</span><span class="p">,</span> <span class="nx">ns</span> <span class="kt">string</span><span class="p">)</span> <span class="kt">error</span> <span class="p">{</span>

    <span class="nx">fruits</span> <span class="o">:=</span> <span class="p">[]</span><span class="nx">ent</span><span class="p">.</span><span class="nx">Fruit</span><span class="p">{</span>
		<span class="nx">ent</span><span class="p">.</span><span class="nx">Fruit</span><span class="p">{</span><span class="nx">ID</span><span class="p">:</span> <span class="s">&#34;apple&#34;</span><span class="p">,</span> <span class="nx">Name</span><span class="p">:</span> <span class="s">&#34;Apple&#34;</span><span class="p">},</span>
		<span class="nx">ent</span><span class="p">.</span><span class="nx">Fruit</span><span class="p">{</span><span class="nx">ID</span><span class="p">:</span> <span class="s">&#34;mango&#34;</span><span class="p">,</span> <span class="nx">Name</span><span class="p">:</span> <span class="s">&#34;Mango&#34;</span><span class="p">},</span>
	<span class="p">}</span>

	<span class="nx">keys</span> <span class="o">:=</span> <span class="nb">make</span><span class="p">([]</span><span class="o">*</span><span class="nx">datastore</span><span class="p">.</span><span class="nx">Key</span><span class="p">,</span> <span class="nb">len</span><span class="p">(</span><span class="nx">fruits</span><span class="p">))</span>

	<span class="k">for</span> <span class="nx">idx</span><span class="p">,</span> <span class="nx">fruit</span> <span class="o">:=</span> <span class="k">range</span> <span class="nx">fruits</span> <span class="p">{</span>
		<span class="nx">keys</span><span class="p">[</span><span class="nx">idx</span><span class="p">]</span> <span class="p">=</span> <span class="nx">datastore</span><span class="p">.</span><span class="nf">NameKey</span><span class="p">(</span><span class="s">&#34;Fruits&#34;</span><span class="p">,</span> <span class="nx">fruit</span><span class="p">.</span><span class="nx">ID</span><span class="p">,</span> <span class="kc">nil</span><span class="p">)</span>
	    <span class="nx">keys</span><span class="p">[</span><span class="nx">idx</span><span class="p">].</span><span class="nx">Namespace</span> <span class="p">=</span> <span class="nx">ns</span>
	<span class="p">}</span>

	<span class="nx">_</span><span class="p">,</span> <span class="nx">err</span> <span class="o">:=</span> <span class="nx">t</span><span class="p">.</span><span class="nf">PutMulti</span><span class="p">(</span><span class="nx">keys</span><span class="p">,</span> <span class="nx">fruits</span><span class="p">)</span>

	<span class="k">return</span> <span class="nx">err</span>
<span class="p">}</span></code></pre></div>
<p>Great! Our first migration script is ready. Now all that remains is to use the unison library to migrate this script. For that let&rsquo;s make changes to <code>main.go</code>.</p>
<div class="highlight"><pre class="chroma"><code class="language-go" data-lang="go"><span class="kn">package</span> <span class="nx">main</span>

<span class="kn">import</span> <span class="p">(</span>
    <span class="s">&#34;context&#34;</span>

    <span class="s">&#34;goapp/gcp&#34;</span>

    <span class="s">&#34;cloud.google.com/go/datastore&#34;</span>
    <span class="s">&#34;github.com/utsavgupta/go-unison/unison&#34;</span>
<span class="p">)</span>

<span class="kd">const</span> <span class="p">(</span>
	<span class="nx">namespace</span> <span class="p">=</span> <span class="s">&#34;unison-demo&#34;</span>
<span class="p">)</span>

<span class="kd">func</span> <span class="nf">main</span><span class="p">()</span> <span class="p">{</span>

	<span class="nx">dsClient</span><span class="p">,</span> <span class="nx">err</span> <span class="o">:=</span> <span class="nx">datastore</span><span class="p">.</span><span class="nf">NewClient</span><span class="p">(</span><span class="nx">context</span><span class="p">.</span><span class="nf">Background</span><span class="p">(),</span> <span class="s">&#34;*detect-project-id*&#34;</span><span class="p">)</span>

	<span class="k">if</span> <span class="nx">err</span> <span class="o">!=</span> <span class="kc">nil</span> <span class="p">{</span>
		<span class="nb">panic</span><span class="p">(</span><span class="nx">err</span><span class="p">)</span>
	<span class="p">}</span>

	<span class="kd">var</span> <span class="nx">unisonMigrations</span> <span class="nx">gcp</span><span class="p">.</span><span class="nx">UnisonMigrations</span>

	<span class="nx">unison</span><span class="p">.</span><span class="nf">RunMigrations</span><span class="p">(</span><span class="nx">dsClient</span><span class="p">,</span> <span class="nx">namespace</span><span class="p">,</span> <span class="o">&amp;</span><span class="nx">unisonMigrations</span><span class="p">)</span>
<span class="p">}</span></code></pre></div>
<p>We are a step away from migrating our first entities to Datastore. Before running the code make sure you have Google application credentials set. More on it <a href="https://cloud.google.com/docs/authentication/production">here</a>.</p>

<p>After you have set the variable you will be ready to run your shiny new migration script.</p>
<div class="highlight"><pre class="chroma"><code class="language-text" data-lang="text">goapp $ go run .
Running Unison
Applying migration 1584477480 ... Done
We are done !!</code></pre></div>
<p>Yay ! We are done migrating our first migration script. Head over to the Google Cloud console to verify the changes.</p>

<p><img src="/img/unison-fruit-1.png" alt="alt text" title="Fruit entities on Datastore" /></p>

<p>Note that the migration records themselves are stored as entites of kind <code>UnisonMigrationMeta</code>.</p>

<p><img src="/img/unison-migrations-1.png" alt="alt text" title="Migration entities" /></p>

<p>Now with the first migration script done, let&rsquo;s create a new script to migrate a few more fruits.</p>
<div class="highlight"><pre class="chroma"><code class="language-bash" data-lang="bash">goapp $ unisoner --migration_package gcp
Filename <span class="o">[</span>.go extension is automatically appended<span class="o">]</span> <span class="o">(</span>default -&gt; Apply1584126043<span class="o">)</span>: more_fruits
Description: add more fruits</code></pre></div>
<p>Edit the newly created <code>gcp/more_fruits.go</code> file to migrate a few more fruits.</p>
<div class="highlight"><pre class="chroma"><code class="language-go" data-lang="go"><span class="kn">package</span> <span class="nx">gcp</span>

<span class="kn">import</span> <span class="p">(</span>
    <span class="s">&#34;goapp/ent&#34;</span>

    <span class="s">&#34;cloud.google.com/go/datastore&#34;</span>
<span class="p">)</span>

<span class="c1">// Apply1584126043 add fruits
</span><span class="c1"></span><span class="kd">func</span> <span class="p">(</span><span class="nx">u</span> <span class="o">*</span><span class="nx">UnisonMigrations</span><span class="p">)</span> <span class="nf">Apply1584126043</span><span class="p">(</span><span class="nx">t</span> <span class="o">*</span><span class="nx">datastore</span><span class="p">.</span><span class="nx">Transaction</span><span class="p">,</span> <span class="nx">ns</span> <span class="kt">string</span><span class="p">)</span> <span class="kt">error</span> <span class="p">{</span>

    <span class="nx">fruits</span> <span class="o">:=</span> <span class="p">[]</span><span class="nx">ent</span><span class="p">.</span><span class="nx">Fruit</span><span class="p">{</span>
		<span class="nx">ent</span><span class="p">.</span><span class="nx">Fruit</span><span class="p">{</span><span class="nx">ID</span><span class="p">:</span> <span class="s">&#34;banana&#34;</span><span class="p">,</span> <span class="nx">Name</span><span class="p">:</span> <span class="s">&#34;Banana&#34;</span><span class="p">},</span>
		<span class="nx">ent</span><span class="p">.</span><span class="nx">Fruit</span><span class="p">{</span><span class="nx">ID</span><span class="p">:</span> <span class="s">&#34;orange&#34;</span><span class="p">,</span> <span class="nx">Name</span><span class="p">:</span> <span class="s">&#34;Orange&#34;</span><span class="p">},</span>
		<span class="nx">ent</span><span class="p">.</span><span class="nx">Fruit</span><span class="p">{</span><span class="nx">ID</span><span class="p">:</span> <span class="s">&#34;watermelon&#34;</span><span class="p">,</span> <span class="nx">Name</span><span class="p">:</span> <span class="s">&#34;Watermelon&#34;</span><span class="p">},</span>
	<span class="p">}</span>

	<span class="nx">keys</span> <span class="o">:=</span> <span class="nb">make</span><span class="p">([]</span><span class="o">*</span><span class="nx">datastore</span><span class="p">.</span><span class="nx">Key</span><span class="p">,</span> <span class="nb">len</span><span class="p">(</span><span class="nx">fruits</span><span class="p">))</span>

	<span class="k">for</span> <span class="nx">idx</span><span class="p">,</span> <span class="nx">fruit</span> <span class="o">:=</span> <span class="k">range</span> <span class="nx">fruits</span> <span class="p">{</span>
		<span class="nx">keys</span><span class="p">[</span><span class="nx">idx</span><span class="p">]</span> <span class="p">=</span> <span class="nx">datastore</span><span class="p">.</span><span class="nf">NameKey</span><span class="p">(</span><span class="s">&#34;Fruits&#34;</span><span class="p">,</span> <span class="nx">fruit</span><span class="p">.</span><span class="nx">ID</span><span class="p">,</span> <span class="kc">nil</span><span class="p">)</span>
	    <span class="nx">keys</span><span class="p">[</span><span class="nx">idx</span><span class="p">].</span><span class="nx">Namespace</span> <span class="p">=</span> <span class="nx">ns</span>
	<span class="p">}</span>

	<span class="nx">_</span><span class="p">,</span> <span class="nx">err</span> <span class="o">:=</span> <span class="nx">t</span><span class="p">.</span><span class="nf">PutMulti</span><span class="p">(</span><span class="nx">keys</span><span class="p">,</span> <span class="nx">fruits</span><span class="p">)</span>

	<span class="k">return</span> <span class="nx">err</span>
<span class="p">}</span></code></pre></div>
<p>Running <code>go run .</code> again should migrate only the new migration script.</p>
<div class="highlight"><pre class="chroma"><code class="language-text" data-lang="text">goapp $ go run .
Running Unison
Applying migration 1584126043 ... Done
We are done !!</code></pre></div>
<p><em>Please note: The project is in it&rsquo;s early stages. Contributions in terms of bug reports, documentation, and testing are welcome. Do not hesitate to report issues or to raise pull requests.</em></p>

  </div>
</section>
<section id="tag-pane" class="row meta">
  
  <div class="col-md-12">
    <h6 class="text-right meta">
      
      
      
      TAGS:
      
      
      <a class="meta" href="/tags/datastore">DATASTORE</a>, 
      
      <a class="meta" href="/tags/go">GO</a>, 
      
      <a class="meta" href="/tags/unison">UNISON</a>
      
      
      
    </h6>
  </div>
  
</section>




<div id="disqus_thread"></div>
<script type="application/javascript">
    var disqus_config = function () {
    
    
    
    };
    (function() {
        if (["localhost", "127.0.0.1"].indexOf(window.location.hostname) != -1) {
            document.getElementById('disqus_thread').innerHTML = 'Disqus comments not available by default when the website is previewed locally.';
            return;
        }
        var d = document, s = d.createElement('script'); s.async = true;
        s.src = '//' + "utsavgupta" + '.disqus.com/embed.js';
        s.setAttribute('data-timestamp', +new Date());
        (d.head || d.body).appendChild(s);
    })();
</script>
<noscript>Please enable JavaScript to view the <a href="https://disqus.com/?ref_noscript">comments powered by Disqus.</a></noscript>
<a href="https://disqus.com" class="dsq-brlink">comments powered by <span class="logo-disqus">Disqus</span></a>



<section id="menu-pane" class="row menu text-center">
  
  
  
  
  
  <h4 class="text-center"><a class="menu-item" href="/">home</a></h4>
</section>



<footer class="row text-center footer">
  <hr />
  
  <h6 class="text-center copyright">Â© 2020. Utsav Gupta. <a href="http://creativecommons.org/licenses/by/3.0/">Some Rights Reserved</a>.</h6>
  
  <h6 class="text-center powered">Powered by <a href="https://gohugo.io/">Hugo  v0.55.6</a> &amp; <a href="https://github.com/shenoybr/hugo-goa">Goa</a>. Hosted on <a href="https://www.netlify.com/">Netlify</a>.</h6>
  
      
      <h6><a href="" aria-label="RSS Feed"><i class="fas fa-rss" aria-hidden="true"></i></a></h6>
    
  
</footer>

</div>



<script src="https://cdnjs.cloudflare.com/ajax/libs/highlight.js/9.12.0/highlight.min.js"></script>
  

<script type="text/javascript">
hljs.initHighlightingOnLoad();
</script>




<script type="application/javascript">
var doNotTrack = false;
if (!doNotTrack) {
	window.ga=window.ga||function(){(ga.q=ga.q||[]).push(arguments)};ga.l=+new Date;
	ga('create', 'UA-161000849-1', 'auto');
	
	ga('send', 'pageview');
}
</script>
<script async src='https://www.google-analytics.com/analytics.js'></script>

<script src="https://ajax.googleapis.com/ajax/libs/jquery/1.12.4/jquery.min.js"></script>
<script src="https://maxcdn.bootstrapcdn.com/bootstrap/3.3.7/js/bootstrap.min.js" integrity="sha384-Tc5IQib027qvyjSMfHjOMaLkfuWVxZxUPnCJA7l2mCWNIpG9mGCD8wGNIcPD7Txa" crossorigin="anonymous"></script>
<script src="js/main.js"></script>
<script src="js/custom.js"></script>
</body>
</html>


